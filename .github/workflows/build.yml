name: Build

on:
  release:
    types:
      - published
  workflow_dispatch:

jobs:
  read_package:
    name: Read Package
    runs-on: ubuntu-latest
    outputs:
      packageJson: ${{ steps.packageJson.outputs.packageJson }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v2

      - name: Get package.json
        id: packageJson
        run: |
          content=`cat ./package.json`
          # the following lines are only required for multi line json
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          # end of optional handling for multi line json
          echo "::set-output name=packageJson::$content"

      - name: Get version
        id: version
        run: echo "::set-output name=version::${{ fromJson(steps.packageJson.outputs.packageJson).version }}"

  build_unitypackage:
    name: Build unitypackage
    runs-on: ubuntu-latest
    needs: read_package
    steps:
      - uses: actions/checkout@v2
        with:
          lfs: true

      - uses: actions/cache@v2
        with:
          path: Unity.AlgoSdk/Library
          key: Library-build_unitypackage-Unity.AlgoSdk-StandaloneLinux64
          restore-keys: |
            Library-build_unitypackage-Unity.AlgoSdk-

      - name: Package unitypackage
        uses: game-ci/unity-builder@v2
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE_2020 }}
        with:
          targetPlatform: StandaloneLinux64
          projectPath: Unity.AlgoSdk
          buildMethod: UnityPackage.Build
          versioning: None
          allowDirtyBuild: true

      - name: Move unitypackage to dist folder
        run: |
          mkdir dist
          mv Unity.AlgoSdk/unity-algorand-sdk.unitypackage dist/unity-algorand-sdk-${{ needs.read_package.outputs.version }}.unitypackage

      - name: Upload dist
        uses: actions/upload-artifact@v2
        with:
          name: dist
          path: dist

      - name: Add unitypackage to Release
        if: github.event.release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/*.unitypackage
          overwrite: true

  build_docs:
    name: Build Docs
    runs-on: ubuntu-latest
    needs: read_package
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          lfs: true

      - name: Build Docs
        uses: nikeee/docfx-action@v1.0.0
        with:
          args: .docfx/docfx.json

      - name: Deploy Docs
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: _site
          destination_dir: ${{ needs.read_package.outputs.version }}
